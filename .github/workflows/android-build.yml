name: Android CI - 延迟测试游戏

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # 允许手动触发

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      JAVA_HOME: /usr/lib/jvm/java-17-openjdk-amd64
      ANDROID_API_LEVEL: 33
      ANDROID_BUILD_TOOLS: "33.0.2"
      ANDROID_NDK_VERSION: "25.1.8937393"

    steps:
    - name: Checkout代码
      uses: actions/checkout@v4

    - name: 设置Java 17
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: 17

    - name: 安装Android SDK工具
      run: |
        sudo apt-get update
        sudo apt-get install -y wget unzip
        mkdir -p $HOME/android-sdk
        export ANDROID_SDK_ROOT=$HOME/android-sdk
        echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
        echo "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin" >> $GITHUB_PATH
        echo "$ANDROID_SDK_ROOT/platform-tools" >> $GITHUB_PATH

        # 下载并安装Android命令行工具
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip -O cmdline-tools.zip
        unzip -q cmdline-tools.zip -d $ANDROID_SDK_ROOT/cmdline-tools
        mv $ANDROID_SDK_ROOT/cmdline-tools/cmdline-tools $ANDROID_SDK_ROOT/cmdline-tools/latest

        # 接受许可证
        yes | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --sdk_root=$ANDROID_SDK_ROOT --licenses

        # 安装必要的SDK组件
        $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --sdk_root=$ANDROID_SDK_ROOT \
          "platform-tools" \
          "platforms;android-$ANDROID_API_LEVEL" \
          "build-tools;$ANDROID_BUILD_TOOLS" \
          "ndk;$ANDROID_NDK_VERSION"

    - name: 缓存Gradle依赖
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: 设置执行权限
      run: chmod +x ./gradlew

    - name: 构建Debug APK
      run: ./gradlew assembleDebug --no-daemon --stacktrace

    - name: 构建Release APK (无签名)
      run: ./gradlew assembleRelease --no-daemon --stacktrace

    - name: 上传Debug APK
      uses: actions/upload-artifact@v4
      with:
        name: latency-test-game-debug
        path: app/build/outputs/apk/debug/*.apk
        retention-days: 30

    - name: 上传Release APK
      uses: actions/upload-artifact@v4
      with:
        name: latency-test-game-release
        path: app/build/outputs/apk/release/*.apk
        retention-days: 30

    - name: 显示构建信息
      run: |
        echo "🎮 构建完成!"
        echo "📱 Debug APK已上传"
        echo "🚀 Release APK已上传"
        echo "📊 文件大小:"
        ls -lah app/build/outputs/apk/debug/
        ls -lah app/build/outputs/apk/release/
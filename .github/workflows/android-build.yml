name: Android CI - å»¶è¿Ÿæµ‹è¯•æ¸¸æˆ

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      JAVA_HOME: /usr/lib/jvm/java-17-openjdk-amd64
      ANDROID_API_LEVEL: 33
      ANDROID_BUILD_TOOLS: "33.0.2"
      ANDROID_NDK_VERSION: "25.1.8937393"

    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Java 17
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: 17

    - name: å®‰è£…Android SDKå·¥å…·
      run: |
        sudo apt-get update
        sudo apt-get install -y wget unzip
        mkdir -p $HOME/android-sdk
        export ANDROID_SDK_ROOT=$HOME/android-sdk
        echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
        echo "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin" >> $GITHUB_PATH
        echo "$ANDROID_SDK_ROOT/platform-tools" >> $GITHUB_PATH

        # ä¸‹è½½å¹¶å®‰è£…Androidå‘½ä»¤è¡Œå·¥å…·
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip -O cmdline-tools.zip
        unzip -q cmdline-tools.zip -d $ANDROID_SDK_ROOT/cmdline-tools
        mv $ANDROID_SDK_ROOT/cmdline-tools/cmdline-tools $ANDROID_SDK_ROOT/cmdline-tools/latest

        # æ¥å—è®¸å¯è¯
        yes | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --sdk_root=$ANDROID_SDK_ROOT --licenses

        # å®‰è£…å¿…è¦çš„SDKç»„ä»¶
        $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --sdk_root=$ANDROID_SDK_ROOT \
          "platform-tools" \
          "platforms;android-$ANDROID_API_LEVEL" \
          "build-tools;$ANDROID_BUILD_TOOLS" \
          "ndk;$ANDROID_NDK_VERSION"

    - name: ç¼“å­˜Gradleä¾èµ–
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: è®¾ç½®æ‰§è¡Œæƒé™
      run: chmod +x ./gradlew

    - name: æ„å»ºDebug APK
      run: ./gradlew assembleDebug --no-daemon --stacktrace

    - name: æ„å»ºRelease APK (æ— ç­¾å)
      run: ./gradlew assembleRelease --no-daemon --stacktrace

    - name: ä¸Šä¼ Debug APK
      uses: actions/upload-artifact@v4
      with:
        name: latency-test-game-debug
        path: app/build/outputs/apk/debug/*.apk
        retention-days: 30

    - name: ä¸Šä¼ Release APK
      uses: actions/upload-artifact@v4
      with:
        name: latency-test-game-release
        path: app/build/outputs/apk/release/*.apk
        retention-days: 30

    - name: æ˜¾ç¤ºæ„å»ºä¿¡æ¯
      run: |
        echo "ğŸ® æ„å»ºå®Œæˆ!"
        echo "ğŸ“± Debug APKå·²ä¸Šä¼ "
        echo "ğŸš€ Release APKå·²ä¸Šä¼ "
        echo "ğŸ“Š æ–‡ä»¶å¤§å°:"
        ls -lah app/build/outputs/apk/debug/
        ls -lah app/build/outputs/apk/release/
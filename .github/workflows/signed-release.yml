name: Android Signed Release - å»¶è¿Ÿæµ‹è¯•æ¸¸æˆ

on:
  push:
    tags:
      - 'v*'  # è§¦å‘æ ‡ç­¾æ¨é€æ—¶æ„å»ºç­¾åç‰ˆæœ¬
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘

jobs:
  build-signed-release:
    runs-on: ubuntu-latest
    env:
      JAVA_HOME: /usr/lib/jvm/java-17-openjdk-amd64
      ANDROID_API_LEVEL: 33
      ANDROID_BUILD_TOOLS: "33.0.2"

    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Java 17
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: 17

    - name: å®‰è£…Android SDKå·¥å…·
      run: |
        sudo apt-get update
        sudo apt-get install -y wget unzip
        mkdir -p $HOME/android-sdk
        export ANDROID_SDK_ROOT=$HOME/android-sdk
        echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
        echo "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin" >> $GITHUB_PATH
        echo "$ANDROID_SDK_ROOT/platform-tools" >> $GITHUB_PATH

        # ä¸‹è½½å¹¶å®‰è£…Androidå‘½ä»¤è¡Œå·¥å…·
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip -O cmdline-tools.zip
        unzip -q cmdline-tools.zip -d $ANDROID_SDK_ROOT/cmdline-tools
        mv $ANDROID_SDK_ROOT/cmdline-tools/cmdline-tools $ANDROID_SDK_ROOT/cmdline-tools/latest

        # æ¥å—è®¸å¯è¯
        yes | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --sdk_root=$ANDROID_SDK_ROOT --licenses

        # å®‰è£…å¿…è¦çš„SDKç»„ä»¶
        $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --sdk_root=$ANDROID_SDK_ROOT \
          "platform-tools" \
          "platforms;android-$ANDROID_API_LEVEL" \
          "build-tools;$ANDROID_BUILD_TOOLS"

    - name: åˆ›å»ºkeystoreç›®å½•
      run: mkdir -p app/keystore

    - name: è§£å¯†keystore (å¦‚æœéœ€è¦)
      if: ${{ secrets.KEYSTORE_BASE64 != '' }}
      run: |
        echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > app/keystore/release.keystore
        echo "Keystoreæ–‡ä»¶å·²åˆ›å»º"

    - name: è®¾ç½®æ‰§è¡Œæƒé™
      run: chmod +x ./gradlew

    - name: æ„å»ºç­¾åçš„Release APK
      if: ${{ secrets.KEYSTORE_BASE64 != '' }}
      run: |
        ./gradlew assembleRelease --no-daemon --stacktrace \
          -Pandroid.enableJetifier=true \
          -Pandroid.useAndroidX=true
      env:
        RELEASE_STORE_FILE: ${{ github.workspace }}/app/keystore/release.keystore
        RELEASE_STORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
        RELEASE_KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        RELEASE_KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}

    - name: æ„å»ºæ— ç­¾åçš„Release APK
      if: ${{ secrets.KEYSTORE_BASE64 == '' }}
      run: ./gradlew assembleRelease --no-daemon --stacktrace

    - name: ä¸Šä¼ ç­¾åçš„Release APK
      uses: actions/upload-artifact@v4
      with:
        name: latency-test-game-signed-release
        path: app/build/outputs/apk/release/*.apk
        retention-days: 90

    - name: æ˜¾ç¤ºæ„å»ºä¿¡æ¯
      run: |
        echo "ğŸ® ç­¾åç‰ˆæœ¬æ„å»ºå®Œæˆ!"
        echo "ğŸ“± Release APKå·²ä¸Šä¼ "
        echo "ğŸ“Š æ–‡ä»¶ä¿¡æ¯:"
        ls -lah app/build/outputs/apk/release/

    - name: åˆ›å»ºGitHub Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: å»¶è¿Ÿæµ‹è¯•æ¸¸æˆ ${{ github.ref }}
        body: |
          ## ğŸ® å»¶è¿Ÿæµ‹è¯•æ¸¸æˆæ›´æ–°

          - ç²¾ç¡®çš„æ¯«ç§’çº§å»¶è¿Ÿæµ‹è¯•
          - S/A/B/C/Däº”çº§è¯„ä»·ç³»ç»Ÿ
          - å…³å¡è¿›åº¦å’Œå¾—åˆ†ç³»ç»Ÿ
          - å®æ—¶å»¶è¿Ÿåé¦ˆæ˜¾ç¤º

          ## ğŸ“± ä¸‹è½½APK
          è¯·åœ¨Actionsé¡µé¢ä¸‹è½½å¯¹åº”çš„APKæ–‡ä»¶
        draft: false
        prerelease: false